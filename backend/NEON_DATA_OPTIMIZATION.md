# NEON データ転送量最適化ガイド

## 概要

NEONのデータ転送量が4GBに達する問題に対応するため、包括的なキャッシング戦略と最適化を実装しました。

## 問題の原因

- **キャッシング機構がない**: 毎回DBから同じデータを取得
- **頻繁なAPI呼び出し**: ランキング、タグ、年リストなど
- **N+1クエリ**: 書籍ごとにトップ記事を個別取得（旧実装）
- **過剰なDB接続**: プールサイズが大きすぎた

## 実装した最適化

### 1. メモリベースキャッシング (`cache_service.py`)

高速なインメモリキャッシュを実装し、頻繁にアクセスされるデータをキャッシュします。

#### 特徴
- **TTL（有効期限）サポート**: データの鮮度に応じて自動的に期限切れ
- **スレッドセーフ**: 複数のリクエストでも安全
- **統計情報**: キャッシュヒット率を監視可能
- **自動クリーンアップ**: 期限切れエントリを自動削除

```python
from app.services.cache_service import get_cache_service

cache = get_cache_service()
cache.set("my_key", data, ttl_seconds=300)  # 5分間キャッシュ
result = cache.get("my_key")
```

### 2. ランキングAPIのキャッシング戦略

データの更新頻度とリアルタイム性のバランスを考慮したTTLを設定：

| データ種類 | TTL | 理由 |
|----------|-----|------|
| 全期間ランキング | 10分 | 更新頻度が低い |
| 過去30日以上 | 5分 | 比較的変動が少ない |
| 過去7日以内 | 2分 | リアルタイム性重視 |
| タグフィルタあり | 5分 | 中程度の更新頻度 |
| タグリスト | 15分 | ほぼ静的 |
| 年リスト | 15分 | ほぼ静的 |
| 書籍詳細 | 5分 | 中程度の更新頻度 |

### 3. DB接続プーリングの最適化

NEON向けに接続数を保守的に設定：

```python
# database.py
engine = create_engine(
    settings.DATABASE_URL,
    pool_size=5,           # 5接続（以前: 10）
    max_overflow=10,       # 最大15接続（以前: 30）
    pool_recycle=300,      # 5分ごとにリサイクル
    pool_pre_ping=True,    # 接続前にpingで確認
)
```

**効果**: 不要なDB接続を削減し、データ転送量を最小化

### 4. クエリの最適化

#### get_ranking_fast()
- 1回のSQLでランキングデータ取得（JOIN不要）
- WINDOW関数で全書籍のトップ記事を一括取得（N+1問題解決）
- 合計2クエリで完結

#### get_available_years()
- 直接SQL使用で高速化
- キャッシング併用で頻繁なアクセスに対応

#### get_all_tags()
- キャッシング併用
- 15分間の長いTTLで不要なDB読み込みを削減

## キャッシュ管理

### 管理者エンドポイント

```bash
# キャッシュ統計を取得
GET /api/admin/cache/stats
Authorization: Bearer YOUR_ADMIN_TOKEN

# レスポンス例
{
  "status": "success",
  "stats": {
    "entries": 42,
    "hits": 1523,
    "misses": 145,
    "total_requests": 1668,
    "hit_rate_percent": 91.3
  }
}

# すべてのキャッシュをクリア
POST /api/admin/cache/clear
Authorization: Bearer YOUR_ADMIN_TOKEN

# 期限切れキャッシュをクリーンアップ
POST /api/admin/cache/cleanup
Authorization: Bearer YOUR_ADMIN_TOKEN
```

### キャッシュヒット率の監視

キャッシュヒット率が **80%以上** なら効果的です。

- **90%以上**: 非常に良好
- **80-89%**: 良好
- **70-79%**: 改善の余地あり（TTLを長くする）
- **70%未満**: キャッシュ戦略の見直しが必要

## 期待される効果

### データ転送量削減

| シナリオ | 削減率（推定） |
|---------|-------------|
| ランキングAPI（キャッシュヒット時） | **99%** |
| 書籍詳細API（キャッシュヒット時） | **99%** |
| タグ/年リスト（キャッシュヒット時） | **99%** |
| 全体的な削減効果 | **70-85%** |

### 想定シナリオ

以前の使用量: **4GB**
キャッシュヒット率80%の場合: **約0.8GB** (80%削減)
キャッシュヒット率90%の場合: **約0.4GB** (90%削減)

### パフォーマンス向上

- **レスポンス時間**: 50-200ms → 5-20ms（キャッシュヒット時）
- **DB負荷**: 大幅削減
- **同時リクエスト対応能力**: 向上

## 運用上の注意点

### 1. キャッシュクリアのタイミング

以下の場合はキャッシュをクリアしてください：

- 書籍データを大量更新した後
- データベースを直接修正した後
- ランキングロジックを変更した後

```bash
curl -X POST https://your-api.com/api/admin/cache/clear \
  -H "Authorization: Bearer YOUR_ADMIN_TOKEN"
```

### 2. メモリ使用量

キャッシュはメモリに保存されるため、以下を監視：

- **推定メモリ使用量**: 50-200MB（通常運用時）
- Renderの無料プラン（512MB）でも十分対応可能

### 3. スケジューラーとキャッシュ

毎日のデータ更新後、キャッシュは徐々に更新されます：

- データ更新: 深夜0時（JST）
- 古いキャッシュ: TTL経過で自動的に期限切れ
- 新しいデータ: 次回アクセス時に自動取得

**手動クリアは不要**ですが、即座に反映したい場合はクリア可能。

## トラブルシューティング

### データが古い

**症状**: 最新のデータが表示されない

**解決策**:
```bash
# キャッシュをクリア
curl -X POST https://your-api.com/api/admin/cache/clear \
  -H "Authorization: Bearer YOUR_ADMIN_TOKEN"
```

### キャッシュヒット率が低い

**症状**: ヒット率が70%未満

**原因と解決策**:
1. **TTLが短すぎる**: TTLを長く設定
2. **リクエストパターンが分散**: 同じクエリが少ない（正常）
3. **キャッシュキーの生成問題**: ログで確認

### メモリ不足

**症状**: OutOfMemory エラー

**解決策**:
```bash
# キャッシュをクリア
curl -X POST https://your-api.com/api/admin/cache/clear \
  -H "Authorization: Bearer YOUR_ADMIN_TOKEN"
```

または `cache_service.py` でキャッシュサイズの上限を設定。

## 今後の改善案

### 短期（次のステップ）
- [ ] Redis導入（複数インスタンス間でキャッシュ共有）
- [ ] キャッシュサイズの上限設定
- [ ] LRU（最近使われていない）削除ポリシー

### 中期
- [ ] CDNでのエッジキャッシング
- [ ] クエリ結果のJSON圧縮
- [ ] データベースのマテリアライズドビュー

### 長期
- [ ] GraphQL導入（必要なデータのみ取得）
- [ ] WebSocket（リアルタイム更新）
- [ ] キャッシュウォーミング（事前キャッシュ）

## まとめ

この最適化により、NEONのデータ転送量を **70-90%削減** できる見込みです。

### 最も効果的な施策トップ3

1. **ランキングAPIのキャッシング** - 最も頻繁にアクセスされる
2. **DB接続プーリングの最適化** - 不要な接続を削減
3. **get_ranking_fast()の使用** - N+1問題を解決

### 監視すべき指標

- NEONダッシュボードでのデータ転送量
- キャッシュヒット率（`/api/admin/cache/stats`）
- APIレスポンス時間

---

**作成日**: 2025-10-24
**更新日**: 2025-10-24
**バージョン**: 1.0.0

