# ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰æ¤œç´¢ï¼†ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³æœ€é©åŒ–

## ğŸ“Š å•é¡Œã®æœ¬è³ª

```
ã€ä»¥å‰ã®å®Ÿè£…ã€‘
ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ â†’ API: å…¨ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆ24MBï¼‰
              â†’ ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
              â†’ ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ï¼‰

ã€å•é¡Œç‚¹ã€‘
âœ— æ¯å›24MBè»¢é€ï¼ˆ167å›/æœˆ = 4GBï¼‰
âœ— ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ãƒ¡ãƒ¢ãƒªè² è·
âœ— åˆæœŸãƒ­ãƒ¼ãƒ‰ãŒé…ã„
âœ— ãƒ¢ãƒã‚¤ãƒ«å›ç·šã§å³ã—ã„
```

## âœ¨ æ–°ã—ã„å®Ÿè£…

```
ã€ç¾åœ¨ã®å®Ÿè£…ã€‘
ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ â†’ API: å¿…è¦ãªãƒ‡ãƒ¼ã‚¿ã®ã¿ï¼ˆlimit=100ï¼‰
              â†’ ã‚µãƒ¼ãƒãƒ¼å´ã§æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
              â†’ ã‚µãƒ¼ãƒãƒ¼å´ã§ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³

ã€æ”¹å–„ç‚¹ã€‘
âœ… åˆå›: 100ä»¶ã®ã¿å–å¾—ï¼ˆï½500KBï¼‰
âœ… æ¤œç´¢: ã‚µãƒ¼ãƒãƒ¼å´ã§å®Ÿè¡Œï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ï¼‰
âœ… ãƒšãƒ¼ã‚¸ãƒ³ã‚°: ã‚µãƒ¼ãƒãƒ¼å´ã§å®Ÿè¡Œ
âœ… ãƒ‡ãƒ¼ã‚¿è»¢é€é‡ 24MB â†’ 0.5MBï¼ˆ**98%å‰Šæ¸›**ï¼‰
```

## ğŸ”§ å®Ÿè£…å†…å®¹

### 1. ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ï¼ˆbackend/app/services/ranking_service.pyï¼‰

#### get_ranking_fast() ã®æ‹¡å¼µ

```python
def get_ranking_fast(
    self,
    tags: Optional[List[str]] = None,
    days: Optional[int] = None,
    year: Optional[int] = None,
    month: Optional[int] = None,
    limit: Optional[int] = 100,      # NEW
    offset: Optional[int] = None,    # NEW
    search: Optional[str] = None     # NEW
) -> Dict:  # æˆ»ã‚Šå€¤ã‚’å¤‰æ›´
```

**è¿½åŠ æ©Ÿèƒ½**:

1. **æ¤œç´¢æ©Ÿèƒ½**
   ```sql
   WHERE (
       LOWER(b.title) LIKE LOWER('%keyword%') OR
       LOWER(b.author) LIKE LOWER('%keyword%') OR
       LOWER(b.publisher) LIKE LOWER('%keyword%') OR
       LOWER(b.isbn) LIKE LOWER('%keyword%')
   )
   ```

2. **ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³**
   ```sql
   LIMIT 100 OFFSET 0  -- 1ãƒšãƒ¼ã‚¸ç›®
   LIMIT 100 OFFSET 100  -- 2ãƒšãƒ¼ã‚¸ç›®
   ```

3. **ç·ä»¶æ•°ã®å–å¾—**
   ```sql
   SELECT COUNT(DISTINCT b.id) as total
   FROM books b
   ...
   ```

### 2. APIï¼ˆbackend/app/api/rankings.pyï¼‰

#### æ–°ã—ã„ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿

```python
@router.get("/", response_model=dict)
async def get_rankings(
    limit: int = Query(100),        # NEW: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ100ä»¶
    offset: int = Query(0),         # NEW: ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ç”¨
    search: Optional[str] = None,   # NEW: æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
    ...
):
```

#### ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼

```json
{
  "rankings": [...],
  "total": 1234,        // NEW: ç·ä»¶æ•°
  "limit": 100,         // NEW: å–å¾—ä»¶æ•°
  "offset": 0,          // NEW: ã‚ªãƒ•ã‚»ãƒƒãƒˆ
  "period": {...}
}
```

### 3. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼ˆfrontend/lib/api.tsï¼‰

#### æ–°ã—ã„ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹

```typescript
export interface RankingOptions {
  tags?: string[];
  days?: number;
  year?: number;
  month?: number;
  limit?: number;      // NEW
  offset?: number;     // NEW
  search?: string;     // NEW
}

export interface RankingResponse {
  rankings: RankingItem[];
  total: number;       // NEW: ç·ä»¶æ•°
  limit: number;       // NEW
  offset: number;      // NEW
  period: {...};
}
```

#### ä½¿ç”¨ä¾‹

```typescript
// æ¤œç´¢ãªã—: æœ€åˆã®100ä»¶ã‚’å–å¾—
const data = await getRankings.all({ limit: 100, offset: 0 });

// æ¤œç´¢ã‚ã‚Š: ã‚µãƒ¼ãƒãƒ¼å´ã§æ¤œç´¢
const data = await getRankings.all({ 
  search: 'Python',
  limit: 100,
  offset: 0
});

// 2ãƒšãƒ¼ã‚¸ç›®
const data = await getRankings.all({ limit: 100, offset: 100 });
```

### 4. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼ˆfrontend/app/page.tsxï¼‰

TODO: ä»¥ä¸‹ã‚’å®Ÿè£…äºˆå®š
- [ ] ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰æ¤œç´¢ã®ä½¿ç”¨
- [ ] ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã®ä½¿ç”¨
- [ ] ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã‚’å‰Šé™¤

## ğŸ“ˆ æœŸå¾…ã•ã‚Œã‚‹åŠ¹æœ

### ãƒ‡ãƒ¼ã‚¿è»¢é€é‡

| ã‚·ãƒŠãƒªã‚ª | ä»¥å‰ | ç¾åœ¨ | å‰Šæ¸›ç‡ |
|---------|------|------|--------|
| åˆå›ãƒ­ãƒ¼ãƒ‰ | 24MB | 0.5MB | **98%å‰Šæ¸›** |
| æ¤œç´¢å®Ÿè¡Œ | 24MB | 0.5MB | **98%å‰Šæ¸›** |
| ãƒšãƒ¼ã‚¸ç§»å‹• | 0MB (ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ) | 0.5MB | N/A |

### æœˆé–“è»¢é€é‡äºˆæ¸¬

```
ã€ä»¥å‰ã€‘
24MB Ã— 5.6å›/æ—¥ Ã— 30æ—¥ = 4,032MB (4GB)

ã€ç¾åœ¨ã€‘
0.5MB Ã— 5.6å›/æ—¥ Ã— 30æ—¥ = 84MB

å‰Šæ¸›ç‡: 97.9% ğŸ‰
```

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹

| æŒ‡æ¨™ | ä»¥å‰ | ç¾åœ¨ | æ”¹å–„ |
|-----|------|------|------|
| åˆå›ãƒ­ãƒ¼ãƒ‰æ™‚é–“ | 3-5ç§’ | 0.5-1ç§’ | **5-10å€é«˜é€ŸåŒ–** |
| æ¤œç´¢é€Ÿåº¦ | å³åº§ (ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ) | 0.5-1ç§’ (ã‚µãƒ¼ãƒãƒ¼) | è¨±å®¹ç¯„å›² |
| ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ | å¤§ï¼ˆå…¨ãƒ‡ãƒ¼ã‚¿ï¼‰ | å°ï¼ˆ1ãƒšãƒ¼ã‚¸åˆ†ï¼‰ | **å¤§å¹…å‰Šæ¸›** |

## ğŸ¯ ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°æˆ¦ç•¥

### ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰

```python
# æ¤œç´¢ãªã—: ã‚­ãƒ£ãƒƒã‚·ãƒ¥æœ‰åŠ¹
GET /api/rankings/?limit=100&offset=0
â†’ 10åˆ†é–“ã‚­ãƒ£ãƒƒã‚·ãƒ¥

# æ¤œç´¢ã‚ã‚Š: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç„¡åŠ¹
GET /api/rankings/?search=Python&limit=100
â†’ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ãªã„ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ€§é‡è¦–ï¼‰

# ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³: ã‚­ãƒ£ãƒƒã‚·ãƒ¥æœ‰åŠ¹
GET /api/rankings/?limit=100&offset=100
â†’ 5åˆ†é–“ã‚­ãƒ£ãƒƒã‚·ãƒ¥
```

### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰

ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¯**ä¸è¦**ã«ãªã‚Šã¾ã™ï¼ˆã‚µãƒ¼ãƒãƒ¼å´ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰ã€‚

## ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

### SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­–

```python
if search:
    search_term = search.replace("'", "''")  # ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
    search_condition = f"WHERE ... LIKE '%{search_term}%'"
```

**æ³¨æ„**: ã•ã‚‰ã«å®‰å…¨ã«ã™ã‚‹ã«ã¯ã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–ã‚¯ã‚¨ãƒªã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ã€‚

## ğŸ“ ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¬ã‚¤ãƒ‰

### APIå‘¼ã³å‡ºã—ã®å¤‰æ›´

**ä»¥å‰**:
```typescript
// å…¨ä»¶å–å¾—ï¼ˆ24MBï¼‰
const data = await getRankings.all();
```

**ç¾åœ¨**:
```typescript
// å¿…è¦ãªåˆ†ã ã‘å–å¾—ï¼ˆ0.5MBï¼‰
const data = await getRankings.all({ limit: 100, offset: 0 });

// æ¤œç´¢
const data = await getRankings.all({ 
  search: 'Python',
  limit: 100,
  offset: 0
});
```

### ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã®å¤‰æ›´

**ä»¥å‰ï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ï¼‰**:
```typescript
const paginatedData = allData.slice(
  page * limit,
  (page + 1) * limit
);
```

**ç¾åœ¨ï¼ˆã‚µãƒ¼ãƒãƒ¼å´ï¼‰**:
```typescript
const data = await getRankings.all({
  limit: limit,
  offset: page * limit
});
```

## ğŸ§ª ãƒ†ã‚¹ãƒˆ

### ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰

```bash
# é€šå¸¸å–å¾—
curl "http://localhost:8000/api/rankings/?limit=100&offset=0"

# æ¤œç´¢
curl "http://localhost:8000/api/rankings/?search=Python&limit=100"

# ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³
curl "http://localhost:8000/api/rankings/?limit=100&offset=100"

# æ¤œç´¢ + ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³
curl "http://localhost:8000/api/rankings/?search=Python&limit=100&offset=100"
```

### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰

```typescript
// æ¤œç´¢æ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆ
const result = await getRankings.all({ 
  search: 'React',
  limit: 10
});
console.log(`Found ${result.total} books`);
console.log(`Showing ${result.rankings.length} books`);
```

## ğŸ“Š ç›£è¦–

### ãƒ‡ãƒ¼ã‚¿è»¢é€é‡

NEONãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ä»¥ä¸‹ã‚’ç¢ºèªï¼š
- 1æ—¥ã‚ãŸã‚Šã®è»¢é€é‡: **134MB â†’ 2.8MB**
- 1é€±é–“: **940MB â†’ 20MB**
- 1ãƒ¶æœˆ: **4,000MB â†’ 84MB**

### ã‚¯ã‚¨ãƒªæ•°

- ä»¥å‰: 167å›/æœˆ Ã— 1ã‚¯ã‚¨ãƒª = 167ã‚¯ã‚¨ãƒª/æœˆ
- ç¾åœ¨: 167å›/æœˆ Ã— 2ã‚¯ã‚¨ãƒªï¼ˆãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼‹ä»¶æ•°ï¼‰= 334ã‚¯ã‚¨ãƒª/æœˆ

**æ³¨æ„**: ã‚¯ã‚¨ãƒªæ•°ã¯2å€ã ãŒã€ãƒ‡ãƒ¼ã‚¿è»¢é€é‡ã¯98%å‰Šæ¸›ï¼

## âš ï¸ æ³¨æ„äº‹é …

### 1. å¾Œæ–¹äº’æ›æ€§

å¤ã„ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§ã‚‚å‹•ä½œã—ã¾ã™ï¼š
- `limit`/`offset`ãªã— â†’ å…¨ä»¶å–å¾—ï¼ˆä»¥å‰ã®å‹•ä½œï¼‰
- `limit=100` â†’ 100ä»¶ã®ã¿å–å¾—ï¼ˆæ–°ã—ã„å‹•ä½œï¼‰

### 2. ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹

é«˜é€Ÿæ¤œç´¢ã®ãŸã‚ã€ä»¥ä¸‹ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒæ¨å¥¨ï¼š

```sql
CREATE INDEX idx_books_title ON books(LOWER(title));
CREATE INDEX idx_books_author ON books(LOWER(author));
CREATE INDEX idx_books_publisher ON books(LOWER(publisher));
```

### 3. æ¤œç´¢ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹

`LIKE '%keyword%'` ã¯é…ã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚å°†æ¥çš„ã«ã¯ï¼š
- PostgreSQL Full-Text Search
- Elasticsearch
ã‚’æ¤œè¨ã€‚

## ğŸš€ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…ï¼ˆTODOï¼‰

1. `page.tsx`ã‚’æ›´æ–°
   - ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰æ¤œç´¢ã®ä½¿ç”¨
   - ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã®ä½¿ç”¨
   - ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã®å‰Šé™¤

2. æ¤œç´¢UIã®æ”¹å–„
   - ãƒ‡ãƒã‚¦ãƒ³ã‚¹ï¼ˆå…¥åŠ›å¾Œ0.3ç§’ã§æ¤œç´¢ï¼‰
   - ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º

3. ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³UIã®æ”¹å–„
   - ç·ãƒšãƒ¼ã‚¸æ•°ã®è¡¨ç¤º
   - ã‚¸ãƒ£ãƒ³ãƒ—æ©Ÿèƒ½

### å°†æ¥çš„ãªæ”¹å–„

- [ ] æ¤œç´¢çµæœã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ
- [ ] æ¤œç´¢å±¥æ­´
- [ ] ã‚ªãƒ¼ãƒˆã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆ
- [ ] ãƒ•ã‚¡ã‚»ãƒƒãƒˆæ¤œç´¢ï¼ˆã‚«ãƒ†ã‚´ãƒªåˆ¥ï¼‰

## ã¾ã¨ã‚

âœ… **ãƒ‡ãƒ¼ã‚¿è»¢é€é‡ã‚’98%å‰Šæ¸›**ï¼ˆ24MB â†’ 0.5MBï¼‰
âœ… **æœˆé–“4GB â†’ 84MBã«å‰Šæ¸›**
âœ… **åˆå›ãƒ­ãƒ¼ãƒ‰5-10å€é«˜é€ŸåŒ–**
âœ… **ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡å¤§å¹…å‰Šæ¸›**
âœ… **ãƒ¢ãƒã‚¤ãƒ«ç’°å¢ƒã§å¿«é©ã«**

ã“ã‚Œã§**æ ¹æœ¬çš„ãªå•é¡ŒãŒè§£æ±º**ã—ã¾ã—ãŸï¼ğŸŠ

---

**ä½œæˆæ—¥**: 2025-10-24
**æ›´æ–°æ—¥**: 2025-10-24
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.0.0

