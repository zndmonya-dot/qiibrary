# BookTuber - å°†æ¥ã‚’è¦‹è¶Šã—ãŸã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆ

## ğŸ“‹ ç›®æ¬¡

1. [å…¨ä½“ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£](#å…¨ä½“ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£)
2. [ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£æˆ¦ç•¥](#ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£æˆ¦ç•¥)
3. [ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ](#ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ)
4. [ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥](#ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥)
5. [ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ãƒ»åˆ†æ](#ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°åˆ†æ)
6. [ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£](#ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£)
7. [ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–](#ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–)
8. [å°†æ¥ã®æ‹¡å¼µæ©Ÿèƒ½](#å°†æ¥ã®æ‹¡å¼µæ©Ÿèƒ½)

---

## ğŸ—ï¸ å…¨ä½“ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### **ç¾åœ¨ã®æ§‹æˆ**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             â”‚      â”‚             â”‚      â”‚              â”‚
â”‚  ãƒ¦ãƒ¼ã‚¶ãƒ¼    â”‚ â”€â”€â”€â–¶ â”‚  Next.js    â”‚ â”€â”€â”€â–¶ â”‚   FastAPI    â”‚
â”‚  (Browser)  â”‚      â”‚  Frontend   â”‚      â”‚   Backend    â”‚
â”‚             â”‚      â”‚  (Vercel)   â”‚      â”‚  (Railway)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚                     â”‚
                            â”‚                     â–¼
                            â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚              â”‚  PostgreSQL  â”‚
                            â”‚              â”‚  (Supabase)  â”‚
                            â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚  Redis Cache â”‚
                     â”‚  (Railway)   â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **å°†æ¥ã®ã‚¹ã‚±ãƒ¼ãƒ©ãƒ–ãƒ«ãªæ§‹æˆ**

```
                                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                  â”‚   CloudFlare    â”‚
                                  â”‚   CDN + DDoS    â”‚
                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                           â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                      â”‚                      â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚   Next.js      â”‚     â”‚   Next.js   â”‚      â”‚    Next.js     â”‚
            â”‚   (Vercel)     â”‚     â”‚   (Vercel)  â”‚      â”‚    (Vercel)    â”‚
            â”‚   Global CDN   â”‚     â”‚  Edge Cache â”‚      â”‚   Edge API     â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚                                           â”‚
                     â”‚                                           â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚  Load Balancer      â”‚
                            â”‚  (AWS ALB)          â”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                      â”‚                      â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   FastAPI      â”‚     â”‚   FastAPI   â”‚      â”‚    FastAPI     â”‚
        â”‚   Instance 1   â”‚     â”‚  Instance 2 â”‚      â”‚   Instance N   â”‚
        â”‚   (ECS/K8s)    â”‚     â”‚ (ECS/K8s)   â”‚      â”‚   (ECS/K8s)    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚                   â”‚                      â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                â”‚                â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚  PostgreSQL    â”‚  â”‚   Redis    â”‚  â”‚   Elasticsearchâ”‚
            â”‚  Read Replica  â”‚  â”‚   Cluster  â”‚  â”‚   (æ¤œç´¢æ©Ÿèƒ½)    â”‚
            â”‚  (RDS)         â”‚  â”‚  (ElasticCache)â”‚ â”‚              â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚  PostgreSQL    â”‚
            â”‚  Primary (RDS) â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚   S3 Backup    â”‚
            â”‚   (Daily)      â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ˆ ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£æˆ¦ç•¥

### **1. æ°´å¹³ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ï¼ˆHorizontal Scalingï¼‰**

#### **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰**
- VercelãŒè‡ªå‹•ã§ã‚¨ãƒƒã‚¸ã‚µãƒ¼ãƒãƒ¼ã«ãƒ‡ãƒ—ãƒ­ã‚¤
- CDNã«ã‚ˆã‚‹é™çš„ã‚³ãƒ³ãƒ†ãƒ³ãƒ„é…ä¿¡
- ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹é–¢æ•°ã«ã‚ˆã‚‹å‹•çš„ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°

#### **ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰**
- Dockerã‚³ãƒ³ãƒ†ãƒŠåŒ–
- Kubernetesã¾ãŸã¯ AWS ECS ã«ã‚ˆã‚‹è‡ªå‹•ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°
- ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚µãƒ¼ã«ã‚ˆã‚‹è² è·åˆ†æ•£

```yaml
# Kubernetes HPA (Horizontal Pod Autoscaler) ä¾‹
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: booktuber-api
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: booktuber-api
  minReplicas: 2
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
```

### **2. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°**

#### **Read Replicaï¼ˆèª­ã¿å–ã‚Šãƒ¬ãƒ—ãƒªã‚«ï¼‰**
```python
# backend/app/database.py ã«è¿½åŠ 

# Writeç”¨ï¼ˆPrimaryï¼‰
write_engine = create_engine(settings.DATABASE_URL)
WriteSessionLocal = sessionmaker(bind=write_engine)

# Readç”¨ï¼ˆReplicaï¼‰
read_engine = create_engine(settings.DATABASE_READ_REPLICA_URL)
ReadSessionLocal = sessionmaker(bind=read_engine)

def get_read_db():
    """èª­ã¿å–ã‚Šå°‚ç”¨DBã‚»ãƒƒã‚·ãƒ§ãƒ³"""
    db = ReadSessionLocal()
    try:
        yield db
    finally:
        db.close()

def get_write_db():
    """æ›¸ãè¾¼ã¿ç”¨DBã‚»ãƒƒã‚·ãƒ§ãƒ³"""
    db = WriteSessionLocal()
    try:
        yield db
    finally:
        db.close()
```

#### **ã‚·ãƒ£ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ï¼ˆå°†æ¥çš„ã«ï¼‰**
- ãƒ­ã‚±ãƒ¼ãƒ«åˆ¥ï¼ˆja, enï¼‰ã§ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’åˆ†å‰²
- ASINã®ç¯„å›²ã§ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æ•£

### **3. ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥ã®å¼·åŒ–**

```python
# backend/app/cache.py - æ–°è¦ä½œæˆæ¨å¥¨

import redis
from typing import Optional, Any
import json
import hashlib

class CacheManager:
    def __init__(self, redis_url: str):
        self.redis = redis.from_url(redis_url)
    
    def get(self, key: str) -> Optional[Any]:
        """ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å–å¾—"""
        data = self.redis.get(key)
        if data:
            return json.loads(data)
        return None
    
    def set(self, key: str, value: Any, ttl: int = 3600):
        """ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜"""
        self.redis.setex(
            key,
            ttl,
            json.dumps(value, default=str)
        )
    
    def invalidate(self, pattern: str):
        """ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥å‰Šé™¤"""
        for key in self.redis.scan_iter(pattern):
            self.redis.delete(key)
    
    def generate_cache_key(self, *args, **kwargs) -> str:
        """ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼ã‚’ç”Ÿæˆ"""
        key_data = f"{args}:{kwargs}"
        return hashlib.md5(key_data.encode()).hexdigest()

# ä½¿ç”¨ä¾‹
cache = CacheManager(settings.REDIS_URL)

@router.get("/rankings/daily")
async def get_daily_rankings(locale: str = "ja"):
    cache_key = f"ranking:daily:{locale}"
    
    # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚§ãƒƒã‚¯
    cached = cache.get(cache_key)
    if cached:
        return cached
    
    # DBã‹ã‚‰å–å¾—
    rankings = fetch_rankings_from_db(locale)
    
    # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜ï¼ˆ1æ™‚é–“ï¼‰
    cache.set(cache_key, rankings, ttl=3600)
    
    return rankings
```

---

## ğŸ—„ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ

### **ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æˆ¦ç•¥**

```sql
-- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹é‡è¦–ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹

-- 1. ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚¯ã‚¨ãƒªç”¨
CREATE INDEX idx_book_views_locale_date 
ON book_daily_stats(locale, date, total_views DESC);

CREATE INDEX idx_book_mentions_locale 
ON books(locale, total_mentions DESC, total_views DESC);

-- 2. æ›¸ç±æ¤œç´¢ç”¨ï¼ˆå°†æ¥å®Ÿè£…ï¼‰
CREATE INDEX idx_books_title_gin 
ON books USING gin(to_tsvector('english', title));

CREATE INDEX idx_books_author_gin 
ON books USING gin(to_tsvector('english', author));

-- 3. è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_books_locale_updated 
ON books(locale, updated_at DESC);

-- 4. Partial Indexï¼ˆæ¡ä»¶ä»˜ãã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼‰
CREATE INDEX idx_active_books 
ON books(locale, total_views DESC) 
WHERE latest_mention_at > NOW() - INTERVAL '30 days';
```

### **ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ‹ãƒ³ã‚°ï¼ˆå¤§è¦æ¨¡åŒ–æ™‚ï¼‰**

```sql
-- æ—¥æ¬¡çµ±è¨ˆãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æœˆã”ã¨ã«ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³
CREATE TABLE book_daily_stats (
    id BIGSERIAL,
    book_id INTEGER,
    date DATE NOT NULL,
    views INTEGER,
    mentions INTEGER,
    PRIMARY KEY (id, date)
) PARTITION BY RANGE (date);

-- å„æœˆã®ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ã‚’ä½œæˆ
CREATE TABLE book_daily_stats_2024_10 
PARTITION OF book_daily_stats
FOR VALUES FROM ('2024-10-01') TO ('2024-11-01');

CREATE TABLE book_daily_stats_2024_11 
PARTITION OF book_daily_stats
FOR VALUES FROM ('2024-11-01') TO ('2024-12-01');

-- è‡ªå‹•ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ä½œæˆã®Cronã‚¸ãƒ§ãƒ–ã‚’è¨­å®š
```

---

## âš¡ ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥

### **å¤šå±¤ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ§‹æˆ**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 1: Browser Cache (Service Worker)   â”‚
â”‚  TTL: 5 minutes                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚ Cache Miss
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 2: CDN Cache (CloudFlare/Vercel)    â”‚
â”‚  TTL: 15 minutes                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚ Cache Miss
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 3: Redis Cache (Application)        â”‚
â”‚  TTL: 1 hour                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚ Cache Miss
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 4: PostgreSQL (Source of Truth)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç„¡åŠ¹åŒ–æˆ¦ç•¥**

```python
# backend/app/services/ranking_service.py

class RankingService:
    def __init__(self, cache: CacheManager):
        self.cache = cache
    
    def update_rankings(self, locale: str, period: str):
        """ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’æ›´æ–°ã—ã€é–¢é€£ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å‰Šé™¤"""
        # ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¨ˆç®—
        new_rankings = self._calculate_rankings(locale, period)
        
        # DBã«ä¿å­˜
        self._save_to_db(new_rankings)
        
        # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç„¡åŠ¹åŒ–
        self.cache.invalidate(f"ranking:{period}:{locale}*")
        self.cache.invalidate(f"book:*")  # å€‹åˆ¥æ›¸ç±ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚‚å‰Šé™¤
        
        return new_rankings
```

---

## ğŸ“Š ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ãƒ»åˆ†æ

### **1. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ç›£è¦–**

#### **æ¨å¥¨ãƒ„ãƒ¼ãƒ«:**
- **Sentry** - ã‚¨ãƒ©ãƒ¼ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°
- **DataDog / New Relic** - APMï¼ˆApplication Performance Monitoringï¼‰
- **Grafana + Prometheus** - ãƒ¡ãƒˆãƒªã‚¯ã‚¹å¯è¦–åŒ–

```python
# backend/app/main.py ã«Sentryã‚’çµ±åˆ

import sentry_sdk
from sentry_sdk.integrations.fastapi import FastApiIntegration

sentry_sdk.init(
    dsn=settings.SENTRY_DSN,
    integrations=[FastApiIntegration()],
    traces_sample_rate=0.1,  # 10%ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ãƒˆãƒ¬ãƒ¼ã‚¹
    profiles_sample_rate=0.1,
    environment=settings.ENVIRONMENT,
)
```

### **2. ãƒ“ã‚¸ãƒã‚¹åˆ†æï¼ˆæ—¢ã«å®Ÿè£…æ¸ˆã¿ï¼‰**

`frontend/lib/analytics.ts` ã§å®Ÿè£…æ¸ˆã¿ï¼š
- ãƒšãƒ¼ã‚¸ãƒ“ãƒ¥ãƒ¼
- æ›¸ç±ã‚¯ãƒªãƒƒã‚¯
- Amazonã‚¢ãƒ•ã‚£ãƒªã‚¨ã‚¤ãƒˆã‚¯ãƒªãƒƒã‚¯
- YouTubeå‹•ç”»è¦–è´
- ãƒ©ãƒ³ã‚­ãƒ³ã‚°æœŸé–“åˆ‡ã‚Šæ›¿ãˆ
- è¨€èªåˆ‡ã‚Šæ›¿ãˆ

### **3. ã‚«ã‚¹ã‚¿ãƒ ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰**

```python
# backend/app/api/admin/analytics.py - ç®¡ç†è€…ç”¨åˆ†æAPI

@router.get("/analytics/overview")
async def get_analytics_overview(
    start_date: date,
    end_date: date,
    db: Session = Depends(get_db)
):
    """åˆ†æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç”¨ã®ãƒ‡ãƒ¼ã‚¿"""
    return {
        "total_views": get_total_views(db, start_date, end_date),
        "total_clicks": get_total_clicks(db, start_date, end_date),
        "conversion_rate": calculate_conversion_rate(db, start_date, end_date),
        "top_books": get_top_books(db, start_date, end_date, limit=10),
        "affiliate_revenue_estimate": estimate_affiliate_revenue(db, start_date, end_date),
    }
```

---

## ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

### **1. API Rate Limiting**

```python
# backend/app/middleware/rate_limit.py

from slowapi import Limiter, _rate_limit_exceeded_handler
from slowapi.util import get_remote_address

limiter = Limiter(key_func=get_remote_address)

@app.get("/api/rankings/daily")
@limiter.limit("100/minute")  # 1åˆ†é–“ã«100ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¾ã§
async def get_daily_rankings():
    ...
```

### **2. CORSè¨­å®šã®å³æ ¼åŒ–**

```python
# backend/app/main.py

app.add_middleware(
    CORSMiddleware,
    allow_origins=[
        "https://booktuber.com",
        "https://www.booktuber.com",
    ],  # æœ¬ç•ªç’°å¢ƒã§ã¯å…·ä½“çš„ãªãƒ‰ãƒ¡ã‚¤ãƒ³ã®ã¿è¨±å¯
    allow_credentials=True,
    allow_methods=["GET", "POST"],
    allow_headers=["*"],
    max_age=3600,
)
```

### **3. SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­–**

SQLAlchemy ORMã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§è‡ªå‹•çš„ã«å¯¾ç­–æ¸ˆã¿ã€‚
ç”ŸSQLã‚’æ›¸ãå ´åˆã¯å¿…ãšãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–ã‚¯ã‚¨ãƒªã‚’ä½¿ç”¨ã€‚

### **4. ç’°å¢ƒå¤‰æ•°ã®æš—å·åŒ–**

```bash
# AWS Secrets Manager ã‚’ä½¿ç”¨
aws secretsmanager create-secret \
    --name booktuber/production/database \
    --secret-string '{"url":"postgresql://..."}'

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‹ã‚‰å–å¾—
import boto3

def get_secret(secret_name):
    client = boto3.client('secretsmanager')
    response = client.get_secret_value(SecretId=secret_name)
    return json.loads(response['SecretString'])
```

---

## âš¡ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

### **1. ç”»åƒæœ€é©åŒ–**

Next.js Image ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ä½¿ç”¨ï¼ˆæ—¢ã«å®Ÿè£…æ¸ˆã¿ï¼‰

ã•ã‚‰ãªã‚‹æœ€é©åŒ–ï¼š
```typescript
// next.config.js ã«è¿½åŠ 

module.exports = {
  images: {
    formats: ['image/avif', 'image/webp'],  // æœ€æ–°ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå„ªå…ˆ
    deviceSizes: [640, 750, 828, 1080, 1200],
    imageSizes: [16, 32, 48, 64, 96, 128, 256, 384],
    minimumCacheTTL: 86400,  // 24æ™‚é–“
  },
}
```

### **2. ã‚³ãƒ¼ãƒ‰åˆ†å‰²**

```typescript
// å‹•çš„ã‚¤ãƒ³ãƒãƒ¼ãƒˆã§ãƒãƒ³ãƒ‰ãƒ«ã‚µã‚¤ã‚ºã‚’å‰Šæ¸›
import dynamic from 'next/dynamic';

const BookCard = dynamic(() => import('@/components/BookCard'), {
  loading: () => <BookCardSkeleton />,
  ssr: true,
});
```

### **3. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¯ã‚¨ãƒªæœ€é©åŒ–**

```python
# N+1å•é¡Œã‚’å›é¿

# âŒ æ‚ªã„ä¾‹
books = db.query(Book).all()
for book in books:
    videos = db.query(Video).filter(Video.book_id == book.id).all()

# âœ… è‰¯ã„ä¾‹
books = db.query(Book).options(
    joinedload(Book.youtube_videos)
).all()
```

---

## ğŸš€ å°†æ¥ã®æ‹¡å¼µæ©Ÿèƒ½

### **1. æ¤œç´¢æ©Ÿèƒ½**

```typescript
// frontend/components/SearchBar.tsx

export default function SearchBar() {
  const [query, setQuery] = useState('');
  const [results, setResults] = useState([]);
  
  const handleSearch = async (q: string) => {
    const res = await fetch(`/api/search?q=${encodeURIComponent(q)}`);
    const data = await res.json();
    setResults(data);
    analytics.search(q, data.length);
  };
  
  return (
    <input
      type="search"
      placeholder="æ›¸ç±ã‚’æ¤œç´¢..."
      value={query}
      onChange={(e) => {
        setQuery(e.target.value);
        if (e.target.value.length >= 2) {
          handleSearch(e.target.value);
        }
      }}
    />
  );
}
```

### **2. ãƒ¦ãƒ¼ã‚¶ãƒ¼æ©Ÿèƒ½**

- ãŠæ°—ã«å…¥ã‚Šç™»éŒ²
- èª­æ›¸ãƒªã‚¹ãƒˆä½œæˆ
- ãƒ¬ãƒ“ãƒ¥ãƒ¼æŠ•ç¨¿
- ã‚½ãƒ¼ã‚·ãƒ£ãƒ«ã‚·ã‚§ã‚¢

### **3. ãƒ¬ã‚³ãƒ¡ãƒ³ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³**

```python
# backend/app/services/recommendation.py

class RecommendationEngine:
    def get_similar_books(self, book_id: int, limit: int = 5):
        """é¡ä¼¼æ›¸ç±ã‚’æ¨è–¦"""
        # å”èª¿ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
        # ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ™ãƒ¼ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
        # ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ
        pass
    
    def get_personalized_recommendations(self, user_id: int):
        """ãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚ºã•ã‚ŒãŸæ¨è–¦"""
        pass
```

### **4. ãƒ¡ãƒ¼ãƒ«é€šçŸ¥**

- æ–°ç€ãƒ©ãƒ³ã‚­ãƒ³ã‚°é€šçŸ¥
- ãŠæ°—ã«å…¥ã‚Šæ›¸ç±ã®å€¤ä¸‹ã’é€šçŸ¥
- é€±æ¬¡/æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆ

### **5. PWAåŒ–**

```typescript
// next.config.js
const withPWA = require('next-pwa')({
  dest: 'public',
  register: true,
  skipWaiting: true,
});

module.exports = withPWA({
  // existing config
});
```

---

## ğŸ“ ã‚¤ãƒ³ãƒ•ãƒ©æ§‹æˆã®æ®µéšçš„ç§»è¡Œ

### **Phase 1: ã‚¹ãƒ¢ãƒ¼ãƒ«ã‚¹ã‚¿ãƒ¼ãƒˆï¼ˆç¾åœ¨ï¼‰**
- Frontend: Vercelï¼ˆç„¡æ–™æ ï¼‰
- Backend: Railwayï¼ˆ$5/æœˆï¼‰
- DB: Supabaseï¼ˆç„¡æ–™æ ï¼‰
- **ç·ã‚³ã‚¹ãƒˆ: ~700å††/æœˆ**

### **Phase 2: ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯å¢—åŠ ï¼ˆæœˆé–“10ä¸‡PVï¼‰**
- Frontend: Vercel Proï¼ˆ$20/æœˆï¼‰
- Backend: Railway Proï¼ˆ$20/æœˆï¼‰+ Redis
- DB: Railway PostgreSQLï¼ˆ$10/æœˆï¼‰
- **ç·ã‚³ã‚¹ãƒˆ: ~6,500å††/æœˆ**

### **Phase 3: æœ¬æ ¼é‹ç”¨ï¼ˆæœˆé–“100ä¸‡PVï¼‰**
- Frontend: Vercel Pro + CDN
- Backend: AWS ECSï¼ˆ2ã€œ4ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ï¼‰
- DB: AWS RDSï¼ˆMulti-AZï¼‰
- Cache: ElastiCache
- **ç·ã‚³ã‚¹ãƒˆ: ~30,000å††/æœˆ**

### **Phase 4: å¤§è¦æ¨¡é‹ç”¨ï¼ˆæœˆé–“1000ä¸‡PVï¼‰**
- Frontend: Vercel Enterprise
- Backend: Kubernetes on AWS/GCP
- DB: Aurora PostgreSQLï¼ˆRead Replica 3å°ï¼‰
- Cache: Redis Cluster
- Monitoring: DataDog / New Relic
- **ç·ã‚³ã‚¹ãƒˆ: ~150,000å††/æœˆ**

---

## ğŸ¯ ã¾ã¨ã‚

ã“ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆã«ã‚ˆã‚Šã€BookTuberã¯ï¼š

1. **ã‚¹ãƒ¢ãƒ¼ãƒ«ã‚¹ã‚¿ãƒ¼ãƒˆå¯èƒ½** - ä½ã‚³ã‚¹ãƒˆã§é–‹å§‹ã§ãã‚‹
2. **æ®µéšçš„ã«ã‚¹ã‚±ãƒ¼ãƒ«** - ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã«å¿œã˜ã¦æ‹¡å¼µ
3. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç¶­æŒ** - ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥ã§é«˜é€ŸåŒ–
4. **ãƒ‡ãƒ¼ã‚¿é§†å‹•** - ã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹ã§æ„æ€æ±ºå®š
5. **å°†æ¥æ€§** - æ©Ÿèƒ½æ‹¡å¼µã«æŸ”è»Ÿã«å¯¾å¿œ

**ä»Šã™ãå®Ÿè£…ã™ã¹ãå„ªå…ˆäº‹é …ï¼š**
1. âœ… ã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹çµ±åˆï¼ˆå®Ÿè£…æ¸ˆã¿ï¼‰
2. ã‚­ãƒ£ãƒƒã‚·ãƒ¥åŸºç›¤ã®æ•´å‚™ï¼ˆRedisï¼‰
3. ã‚¨ãƒ©ãƒ¼ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ï¼ˆSentryï¼‰
4. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æœ€é©åŒ–
5. CI/CD ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³æ§‹ç¯‰

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚è€ƒã«ã€æ®µéšçš„ã«æˆé•·ã•ã›ã¦ã„ãã¾ã—ã‚‡ã†ï¼ğŸš€

